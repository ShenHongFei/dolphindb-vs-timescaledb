创建分区方案
// data path
FP_DEVICES = '/data/devices/'
FP_INFO 	= FP_DEVICES + 'csv/devices_big_device_info.csv'
FP_READINGS = FP_DEVICES + 'csv/devices_big_readings.csv'

FP_DB = FP_DEVICES + 'db/'

// 创建两张表的 schema
schema_info  	= extractTextSchema(FP_INFO)
schema_readings = extractTextSchema(FP_READINGS)
COLS_INFO 		= `device_id`api_version`manufacturer`model`os_name
COLS_READINGS 	= `time`device_id`battery_level`battery_status`battery_temperature`bssid`cpu_avg_1min`cpu_avg_5min`cpu_avg_15min`mem_free`mem_used`rssi`ssid


schema_info 	= table(COLS_INFO, schema_info.type)
schema_readings = table(COLS_READINGS, schema_readings.type)


// 创建分区数据库并定义分区方式
db = database(FP_DB, RANGE, 2016.11.15T00:00:00 + 86400 * 0..4)


// ----------------- 从 CSV 导入 device_info 表的数据到 device_info 内存表
device_info = loadText(FP_INFO, , schema_info)

// 导出不同的值作为 TimescaleDB 枚举类型的属性
exec distinct api_version from device_info
exec distinct manufacturer from device_info
exec distinct model from device_info
exec distinct os_name from device_info

exec distinct bssid from readings
exec distinct ssid from readings

// ----------------- 从 CSV 导入 readings 表的数据到 readings 数据库并完成数据分区操作
timer readings = loadTextEx(db, `readings, `time, FP_READINGS, , schema_readings)
// 20 s    1.2 GB


// 关闭数据库
close(db)
readings = NULL



// 加载 readings 表
timer readings = loadTable(FP_DB, `readings)
// 30 ms


readings = loadTable(FP_DB, `readings, , true)
readings = loadTable(FP_DB, `readings, 2016.11.15T00:00:00 + 86400 * 0..4, true)


timer select count(*) from readings
// 0.604 ms


// 查看 schema
schema(device_info)
schema(readings)


// ----------------- 导出数据
timer saveText((select * from readings), '/data/devices/readings_dump.csv')
// 17.5 s


// --------------------- 简单查询及内置函数计算
// 按设备 ID 查询记录数
timer
select count(*)
from readings
where device_id = 'demo000101'
// 160 ms


// 查找某时间段内低电量的未充电设备，显示其 ID、最低电量
timer
select min(battery_level)
from readings
where
	time between 2016.11.17 21:00:00 : 2016.11.18 09:00:00,
    battery_level <= 10,
    battery_status = 'discharging'
group by device_id
// 266 ms


// 计算某时间段内高负载高电量设备的内存大小
timer
select
	max(date(time)) as date,
	max(mem_free + mem_used) as mem_all
from readings
where
    time <= 2016.11.18 21:00:00,
    battery_level >= 90,
    cpu_avg_1min > 90
group by hour(time), device_id
// 1306 ms


// 统计连接不同网络的设备的平均电量和最大、最小电量，并按平均电量降序排列
timer
select
    max(battery_level) as max_battery,
    avg(battery_level) as avg_battery,
    min(battery_level) as min_battery
from readings
group by ssid
order by avg_battery desc
// 328 ms


// 查找所有设备平均负载最高的时段，并按照负载降序排列、时间升序排列
timer
select floor(avg(cpu_avg_15min)) as load
from readings
where time between 2016.11.16 00:00:00 : 2016.11.18 00:00:00
group by hour(time) as hour
order by load desc, hour asc;
// 847 ms



// 计算各个时间段内某些设备的总负载，并将时段按总负载降序排列
timer
select sum(cpu_avg_15min) as sum_load
from readings
where
	time between 2016.11.15 12:00:00 : 2016.11.16 12:00:00,
    device_id in ['demo000001', 'demo000010', 'demo000100', 'demo001000']
group by hour(time)
order by sum_load desc
// 35 ms



// 设备电量滑动平均值（moving_average）
timer
select avg(mavg(battery_level, 100))
from readings
group by device_id, hour(time)
// 855 ms
// 873 ms




// --------------- 表连接性能测试
timer
select count(device_info)
from ej(readings, device_info, `device_id)
// 254 ms

timer
select count(device_info)
from lj(readings, device_info, `device_id)
// 230 ms




// ----------------- 经典查询性能测试
// 查询充电设备的最近 20 条电池温度记录
timer
select top 20
    time,
    device_id,
    battery_temperature
from readings
where battery_status = 'charging'
order by time desc
// 385 ms （top 20 没有起到缩小查询范围的作用）


// 查询充电设备的所有电池温度记录
timer
select
    time,
    device_id,
    battery_temperature
from readings
where battery_status = 'charging'
order by time desc
// 57 ms （受上条查询的缓存影响）



// 未在充电的、电量小于 33% 的、平均 1 分钟内最高负载的 5 个设备
timer
select top 5
    readings.device_id,
    battery_level,
    battery_status,
    cpu_avg_1min
from ej(readings, device_info, `device_id)
where battery_level < 33, battery_status = 'discharging'
order by cpu_avg_1min desc, time desc
// 406 ms 



// 未在充电的、电量小于 33% 的、平均 1 分钟内最高负载的所有设备
timer
select
    readings.device_id,
    battery_level,
    battery_status,
    cpu_avg_1min
from ej(readings, device_info, `device_id)
where battery_level < 33, battery_status = 'discharging'
order by cpu_avg_1min desc, time desc
// 617 ms



// 未在充电的、电量小于 33% 的、平均 1 分钟内最高负载的所有设备
timer
select top 5
    readings.device_id,
    battery_level,
    battery_status,
    cpu_avg_1min
from ej(readings, device_info, `device_id)
where battery_level < 33, battery_status = 'discharging'
order by cpu_avg_1min desc, time desc
// 388 ms



// 某两个型号的设备每小时最低电量的前 20 条数据
timer {
	device_ids = 
		exec distinct device_id
		from device_info
		where model = 'pinto' or model = 'focus';

	battery_levels = 
		select min(battery_level) as min_battery_level
		from readings
		where device_id in device_ids
		group by hour(time)
		order by hour_time asc;

	battery_levels[0:20]
}
// 104 ms











